#!/bin/bash
source "${0%/*}/bashlib"                                                      #
nonGnuSed=$(sed -i '' /dev/null >/dev/null 2>&1; [[ $? != 4 ]] && echo 1)

cd "$(readlink -f "${0%/*}/..")"

p=${PWD##*/}
emit "Converting JAR dependencies on safe-online projects to source dependencies" --
    sed -i ${nonGnuSed:+''} '/-client/ ! { /M2_REPO.*\/'"$p"'\// { s,M2_REPO/net/lin-k/'"$p"'/\([^/]*\)/[^"]*,/\1,; s/kind="var"/kind="src"/; } }' */.classpath
    for pp in */.classpath; do
        IFS=$'\n' src=($(grep -F 'kind="src"' "$pp" | cut -d'"' -f4)); unset IFS
        while read -r; do
            line=$REPLY

            [[ $line = *'-client'* ]] && \
                line=$(sed '/'"$p"'/ { s,M2_REPO/net/lin-k/'"$p"'/\([^/]*\)/[^"]*,/\1,; s/kind="var"/kind="src"/ }' <<< "$line")

            echo "$line"
        done < "$pp" > "$pp~"
        #mv -f "$pp~" "$pp"
    done
emit -$?

emit "Setting up project-specific configurations" --
    for p in */.settings; do
        cp scripts/org.eclipse.* "$p" \
        && sed -i ${nonGnuSved:+''} 's/safe-online-projectname/'"${p%%/*}"'/' "$p/org.eclipse.wst.common.component" \
        || break

        # Special configuration for projects with generated sources.
        [[ -e ${p%%/*}/target/generated-sources ]] && {
            for f in scripts/ws~org.eclipse.*; do
                cp "$f" "$p/${f#'scripts/ws~'}" || break 2
            done
        }

        true
    done
emit -$?
